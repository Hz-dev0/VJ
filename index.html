<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>提醒器</title>
<style>
  body {
    font-family: "Microsoft JhengHei", Arial, sans-serif;
    padding: 20px;
    background-color: #f4f4f9;
    display: flex;
    flex-direction: column;
    align-items: center; /* 讓整體內容置中 */
  }

  .inline-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  input[type="text"], input[type="number"] {
    width: 100px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
  }

  button {
    padding: 8px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  button:hover { background-color: #0056b3; }

  /* 滿版提醒畫面與閃動動畫 */
  #overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    color: white;
    font-size: 8vw;
    font-weight: bold;
    text-align: center;
    z-index: 9999;
    cursor: pointer;
    /* 置中對齊 */
    display: none; 
    justify-content: center;
    align-items: center;
  }

  /* 閃動動畫定義 */
  @keyframes flash-bg {
    0% { background-color: black; }
    50% { background-color: #ff0000; } /* 閃爍紅色 */
    100% { background-color: black; }
  }

  .flashing {
    animation: flash-bg 0.5s infinite;
  }

  .notes {
    display: flex;
    gap: 20px;
    margin-top: 30px;
    width: 100%;
    max-width: 1000px;
    justify-content: center;
  }

  textarea {
    width: 45%;
    height: 300px;
    padding: 15px;
    font-size: 1.1em;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    resize: none;
  }
</style>
</head>
<body>

<div class="inline-controls">
  <input type="text" id="startTime" placeholder="開播(如0840)">
  <input type="number" id="minutes" placeholder="間隔(分)">
  <button onclick="startTimer()">開始計時</button>
</div>

<p id="result" style="font-weight: bold; color: #555;"></p>

<div id="overlay" onclick="handleReset()">該填人數了</div>

<div class="notes">
  <textarea id="note1" placeholder="記錄影片時間..."></textarea>
  <textarea id="note2" placeholder="抽獎名單..."></textarea>
</div>

<script>
let originalTitle = document.title;
let intervalMinutes = 0;
let checkTimer = null;
let flashInterval = null;
let notificationRepeatInterval = null; // 重複通知的定時器
let isTimeUp = false;
const overlay = document.getElementById("overlay");

function startTimer() {
    clearAll();
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    const timeStr = document.getElementById("startTime").value;
    intervalMinutes = parseInt(document.getElementById("minutes").value, 10);

    if (!/^\d{4}$/.test(timeStr) || isNaN(intervalMinutes)) {
        alert("格式錯誤！時間請填 0840，間隔請填數字。");
        return;
    }

    let hour = parseInt(timeStr.substring(0,2),10);
    let min = parseInt(timeStr.substring(2,4),10);
    
    // 假設開播是下午，自動 +12 (依你原本邏輯)
    hour = (hour + 12) % 24;

    scheduleNextFromNow(hour, min);
}

function scheduleNextFromNow(hour, min) {
    const now = new Date();
    let target = new Date(now);
    target.setHours(hour, min, 0, 0);
    
    // 如果計算出的起始時間已經過去了，就從「現在」開始加間隔
    while(target <= now){
        target.setMinutes(target.getMinutes() + intervalMinutes);
    }

    scheduleNext(target);
}

function scheduleNext(target){
    document.getElementById("result").innerText = "⏰ 下次提醒：" + target.toLocaleTimeString();
    checkTimer = setInterval(()=>{
        const now = new Date();
        if(now >= target){
            clearInterval(checkTimer);
            onTimeUp();
        }
    },1000);
}

function onTimeUp(){
    isTimeUp = true;
    
    // 1. 畫面閃動與顯示
    overlay.style.display = "flex";
    overlay.classList.add("flashing");

    // 2. 標題閃爍
    startTitleFlash();

    // 3. 立即顯示通知，並開啟每 10 秒重複一次的通知
    showSilentNotification("⭐ 時間到了！", "請填在線人數。");
    notificationRepeatInterval = setInterval(() => {
        showSilentNotification("⭐ 提醒！", "尚未確認人數，請點擊畫面。");
    }, 10000); // 10秒重複一次
}

function handleReset() {
    // 停止所有提醒狀態
    isTimeUp = false;
    overlay.style.display = "none";
    overlay.classList.remove("flashing");
    stopFlash();
    clearInterval(notificationRepeatInterval);

    // 重新計算下一段時間
    const now = new Date();
    const nextTarget = new Date(now.getTime() + intervalMinutes * 60000);
    scheduleNext(nextTarget);
}

function startTitleFlash(){
    let toggle = false;
    flashInterval = setInterval(()=>{
        document.title = toggle ? "【！！！】" : "填人數！";
        toggle = !toggle;
    },500);
}

function stopFlash(){
    clearInterval(flashInterval);
    document.title = originalTitle;
}

function showSilentNotification(title, body){
    if (Notification.permission === "granted") {
        new Notification(title, { body: body, silent: true });
    }
}

// 點擊 Overlay 隱藏
function clearAll(){
    clearInterval(checkTimer);
    clearInterval(notificationRepeatInterval);
    stopFlash();
    overlay.style.display = "none";
    overlay.classList.remove("flashing");
}

// 處理記事本
const note1 = document.getElementById("note1");
const note2 = document.getElementById("note2");
note1.value = localStorage.getItem("note1") || "";
note2.value = localStorage.getItem("note2") || "";
note1.addEventListener("input", () => localStorage.setItem("note1", note1.value));
note2.addEventListener("input", () => localStorage.setItem("note2", note2.value));
</script>

</body>
</html>
