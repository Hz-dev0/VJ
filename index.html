<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æé†’å™¨</title>
<style>
  :root {
    --rose-bg: #f8f1f1;
    --rose-primary: #c98d83; /* ä¹¾ç‡¥ç«ç‘°ä¸»è‰² */
    --rose-secondary: #e2b2a8;
    --rose-dark: #a66d64;
    --text-color: #5d4a47;
  }

  body {
    font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
    padding: 40px 20px;
    background-color: var(--rose-bg);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center; 
    margin: 0;
  }

  .main-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    width: 100%;
    max-width: 600px;
  }

  .inline-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
  }

  input[type="text"], input[type="number"], select {
    padding: 10px;
    border: 1px solid var(--rose-secondary);
    border-radius: 8px;
    outline: none;
    color: var(--text-color);
    transition: border 0.3s;
  }

  input:focus, select:focus {
    border-color: var(--rose-primary);
  }

  button {
    padding: 10px 25px;
    background-color: var(--rose-primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
  }

  button:hover {
    background-color: var(--rose-dark);
  }

  /* æé†’æ–‡å­—å®¹å™¨ */
  .result-container {
    height: 50px; 
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  #result {
    font-weight: bold;
    color: var(--rose-dark);
    margin: 0;
    font-size: 1.1em;
  }

  /* æ»¿ç‰ˆæé†’ç•«é¢ */
  #overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    color: white;
    font-size: 6vw;
    font-weight: bold;
    z-index: 9999;
    cursor: pointer;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  @keyframes flash-bg {
    0% { background-color: #5d4a47; }
    50% { background-color: var(--rose-primary); }
    100% { background-color: #5d4a47; }
  }

  .flashing {
    animation: flash-bg 0.8s infinite;
  }

  .notes {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    width: 100%;
    max-width: 1000px;
    justify-content: center;
  }

  textarea {
    width: 45%;
    height: 350px;
    padding: 20px;
    font-size: 1em;
    border: 1px solid #eee;
    border-radius: 12px;
    background: white;
    color: var(--text-color);
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    resize: vertical;
    outline: none;
  }

  textarea:focus {
    border-color: var(--rose-secondary);
  }
</style>
</head>
<body>

<div class="main-card">
  <div class="inline-controls">
    <input type="text" id="startTime" placeholder="é–‹æ’­(å¦‚0840)" title="è¼¸å…¥å››ä½æ•¸å­—">
    <input type="number" id="minutes" placeholder="é–“éš”(åˆ†)">
    <select id="mode">
      <option value="fixed">å›ºå®šæé†’</option>
      <option value="relative">ç›¸å°æé†’</option>
    </select>
    <button onclick="startTimer()">é–‹å§‹è¨ˆæ™‚</button>
  </div>

  <div class="result-container">
    <p id="result"></p>
  </div>
</div>

<div id="overlay" onclick="handleReset()">
  <div>
    ğŸŒ¸ æ™‚é–“åˆ°äº†<br>
    <span style="font-size: 0.4em; font-weight: normal;">é»æ“Šç•«é¢ç¹¼çºŒè¨ˆæ™‚</span>
  </div>
</div>

<div class="notes">
  <textarea id="note1" placeholder="ğŸ¬ è¨˜éŒ„å½±ç‰‡æ™‚é–“..."></textarea>
  <textarea id="note2" placeholder="ğŸ æŠ½çåå–®é å‚™..."></textarea>
</div>

<script>
let originalTitle = document.title;
let intervalMinutes = 0;
let checkTimer = null;
let flashInterval = null;
let notificationRepeatInterval = null;
let currentTargetTime = null; // å„²å­˜ç›®å‰çš„ç›®æ¨™æ™‚é–“
const overlay = document.getElementById("overlay");

function startTimer() {
    clearAll();
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    const timeStr = document.getElementById("startTime").value;
    intervalMinutes = parseInt(document.getElementById("minutes").value, 10);

    if (!/^\d{4}$/.test(timeStr) || isNaN(intervalMinutes)) {
        alert("è«‹ç¢ºèªè¼¸å…¥æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆæ™‚é–“å¦‚0840ï¼Œé–“éš”å¦‚10ï¼‰");
        return;
    }

    let hour = parseInt(timeStr.substring(0,2),10);
    let min = parseInt(timeStr.substring(2,4),10);
    
    // PM é‚è¼¯ (ä¾æ‚¨å…ˆå‰è¨­å®š +12)
    hour = (hour + 12) % 24;

    const now = new Date();
    let target = new Date(now);
    target.setHours(hour, min, 0, 0);
    
    // åˆå§‹è¨ˆç®—ï¼šæ‰¾åˆ°ä¸‹ä¸€å€‹æé†’é»
    while(target <= now){
        target.setMinutes(target.getMinutes() + intervalMinutes);
    }

    scheduleNext(target);
}

function scheduleNext(target){
    currentTargetTime = target;
    document.getElementById("result").innerText = "ä¸‹ä¸€æ¬¡æé†’ï¼š" + target.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    checkTimer = setInterval(()=>{
        const now = new Date();
        if(now >= target){
            clearInterval(checkTimer);
            onTimeUp();
        }
    }, 1000);
}

function onTimeUp(){
    overlay.style.display = "flex";
    overlay.classList.add("flashing");
    startTitleFlash();

    showSilentNotification("ğŸŒ¸ æé†’æ™‚é–“åˆ°", "è«‹å›é é¢ç¢ºèªäººæ•¸");
    notificationRepeatInterval = setInterval(() => {
        showSilentNotification("ğŸŒ¸ æé†’", "å°šæœªç¢ºèªï¼Œè¨ˆæ™‚æš«åœä¸­");
    }, 10000);
}

function handleReset() {
    overlay.style.display = "none";
    overlay.classList.remove("flashing");
    stopFlash();
    clearInterval(notificationRepeatInterval);

    const mode = document.getElementById("mode").value;
    const now = new Date();
    let nextTarget;

    if (mode === "fixed") {
        // å›ºå®šæ¨¡å¼ï¼šå¾åŸæœ¬çš„ç›®æ¨™æ™‚é–“é»ç¹¼çºŒç´¯åŠ é–“éš”ï¼Œç›´åˆ°è¶…éç¾åœ¨æ™‚é–“
        nextTarget = new Date(currentTargetTime);
        while (nextTarget <= now) {
            nextTarget.setMinutes(nextTarget.getMinutes() + intervalMinutes);
        }
    } else {
        // ç›¸å°æ¨¡å¼ï¼šå¾ã€Œç¾åœ¨ã€å¾€å¾Œæ¨ç®—é–“éš”
        nextTarget = new Date(now.getTime() + intervalMinutes * 60000);
    }

    scheduleNext(nextTarget);
}

function startTitleFlash(){
    let toggle = false;
    flashInterval = setInterval(()=>{
        document.title = toggle ? "ã€ï¼ï¼ï¼ã€‘" : "å¡«äººæ•¸ä¸­";
        toggle = !toggle;
    }, 600);
}

function stopFlash(){
    clearInterval(flashInterval);
    document.title = originalTitle;
}

function showSilentNotification(title, body){
    if (Notification.permission === "granted") {
        new Notification(title, { body: body, silent: true });
    }
}

function clearAll(){
    clearInterval(checkTimer);
    clearInterval(notificationRepeatInterval);
    stopFlash();
    overlay.style.display = "none";
    document.getElementById("result").innerText = "";
}

// è¨˜äº‹æœ¬å­˜æª”
const note1 = document.getElementById("note1");
const note2 = document.getElementById("note2");
note1.value = localStorage.getItem("note1") || "";
note2.value = localStorage.getItem("note2") || "";
note1.addEventListener("input", () => localStorage.setItem("note1", note1.value));
note2.addEventListener("input", () => localStorage.setItem("note2", note2.value));
</script>

</body>
</html>
