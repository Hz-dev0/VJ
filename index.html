<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æé†’å™¨</title>
<style>
  :root {
    --rose-bg: #f8f1f1;
    --rose-primary: #c98d83;
    --rose-secondary: #e2b2a8;
    --rose-dark: #a66d64;
    --text-color: #5d4a47;
  }

  body {
    font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
    padding: 30px 20px;
    background-color: var(--rose-bg);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center; 
    margin: 0;
  }

  .inline-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin-bottom: 5px;
  }

  input[type="text"] { width: 85px; }
  input[type="number"] { width: 65px; }
  
  input[type="text"], input[type="number"], select {
    padding: 8px;
    border: 1px solid var(--rose-secondary);
    border-radius: 6px;
    outline: none;
    color: var(--text-color);
    background-color: white;
  }

  button {
    padding: 8px 16px;
    background-color: var(--rose-primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
  }

  button:hover { background-color: var(--rose-dark); }

  .result-container {
    height: 40px; 
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-bottom: 10px;
  }

  #result { font-weight: bold; color: var(--rose-dark); margin: 0; }

  /* ç­†è¨˜å€å„ªåŒ– */
  .notes {
    display: flex;
    gap: 20px;
    width: 100%;
    max-width: 1100px;
    justify-content: center;
  }

  .note-column {
    display: flex;
    flex-direction: column;
    width: 48%;
    gap: 8px;
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .btn-small {
    padding: 4px 10px;
    font-size: 12px;
    background-color: #eee;
    color: #666;
    border-radius: 4px;
  }

  textarea {
    width: 100%;
    height: 400px;
    padding: 15px;
    font-size: 1em;
    border: 1px solid var(--rose-secondary);
    border-radius: 10px;
    box-sizing: border-box; /* ä¿®æ­£å¯¬åº¦çˆ†å‡ºå»çš„å•é¡Œ */
  }

  #overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    color: white;
    font-size: 6vw;
    font-weight: bold;
    z-index: 9999;
    cursor: pointer;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  @keyframes flash-bg {
    0% { background-color: #5d4a47; }
    50% { background-color: var(--rose-primary); }
    100% { background-color: #5d4a47; }
  }
  .flashing { animation: flash-bg 0.8s infinite; }
</style>
</head>
<body>

<div class="inline-controls">
  <input type="text" id="startTime" placeholder="é–‹æ’­0840">
  <input type="number" id="minutes" placeholder="é–“éš”">
  <select id="mode">
    <option value="fixed">å›ºå®šæ¨¡å¼</option>
    <option value="relative">ç›¸å°æ¨¡å¼</option>
  </select>
  <button onclick="startTimer()">é–‹å§‹è¨ˆæ™‚</button>
</div>

<div class="result-container">
  <p id="result"></p>
</div>

<div id="overlay" onclick="handleReset()">
  <div>ğŸŒ¸ æ™‚é–“åˆ°äº†<br><span style="font-size: 0.4em; font-weight: normal;">é»æ“Šç•«é¢ç¹¼çºŒ</span></div>
</div>

<div class="notes">
  <div class="note-column">
    <div class="note-header">
      <span>ğŸ¬ å½±ç‰‡æ™‚é–“ç´€éŒ„</span>
      <button class="btn-small" onclick="copyText('note1')">è¤‡è£½å…¨éƒ¨</button>
    </div>
    <textarea id="note1"></textarea>
  </div>
  <div class="note-column">
    <div class="note-header">
      <span>ğŸ æŠ½çåå–®</span>
      <button class="btn-small" onclick="copyText('note2')">è¤‡è£½å…¨éƒ¨</button>
    </div>
    <textarea id="note2"></textarea>
  </div>
</div>

<script>
let originalTitle = document.title;
let intervalMinutes = 0;
let checkTimer = null;
let flashInterval = null;
let notificationRepeatInterval = null;
let currentTargetTime = null;
const overlay = document.getElementById("overlay");

// æ”¹å–„å»ºè­° 1: é˜²èª¤é—œé é¢
window.onbeforeunload = function() {
    if (checkTimer) return "è¨ˆæ™‚ä»åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ";
};

// æ”¹å–„å»ºè­° 3: ä¸€éµè¤‡è£½
function copyText(id) {
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
    alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
}

function startTimer() {
    clearAll();
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    const timeStr = document.getElementById("startTime").value;
    intervalMinutes = parseInt(document.getElementById("minutes").value, 10);

    if (!/^\d{4}$/.test(timeStr) || isNaN(intervalMinutes)) {
        alert("æ ¼å¼éŒ¯èª¤ï¼æ™‚é–“å¦‚0840ï¼Œé–“éš”å¦‚10");
        return;
    }

    let hour = parseInt(timeStr.substring(0,2),10);
    let min = parseInt(timeStr.substring(2,4),10);
    hour = (hour + 12) % 24;

    const now = new Date();
    let target = new Date(now);
    target.setHours(hour, min, 0, 0);
    
    while(target <= now){
        target.setMinutes(target.getMinutes() + intervalMinutes);
    }

    scheduleNext(target);
}

function scheduleNext(target){
    currentTargetTime = target;
    document.getElementById("result").innerText = "â° ä¸‹æ¬¡æé†’ï¼š" + target.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    checkTimer = setInterval(()=>{
        const now = new Date();
        if(now >= target){
            clearInterval(checkTimer);
            onTimeUp();
        }
    }, 1000);
}

function onTimeUp(){
    overlay.style.display = "flex";
    overlay.classList.add("flashing");
    startTitleFlash();
    showSilentNotification("ğŸŒ¸ æ™‚é–“åˆ°äº†ï¼", "è«‹å¡«å¯«äººæ•¸ã€‚");
    notificationRepeatInterval = setInterval(() => {
        showSilentNotification("ğŸŒ¸ æé†’", "å°šæœªç¢ºèªï¼Œè¨ˆæ™‚æš«åœä¸­");
    }, 10000);
}

function handleReset() {
    overlay.style.display = "none";
    overlay.classList.remove("flashing");
    stopFlash();
    clearInterval(notificationRepeatInterval);

    const mode = document.getElementById("mode").value;
    const now = new Date();
    let nextTarget;

    if (mode === "fixed") {
        nextTarget = new Date(currentTargetTime);
        while (nextTarget <= now) {
            nextTarget.setMinutes(nextTarget.getMinutes() + intervalMinutes);
        }
    } else {
        nextTarget = new Date(now.getTime() + intervalMinutes * 60000);
    }
    scheduleNext(nextTarget);
}

function startTitleFlash(){
    let toggle = false;
    flashInterval = setInterval(()=>{
        document.title = toggle ? "æ™‚é–“åˆ°" : "è«‹å¡«äººæ•¸";
        toggle = !toggle;
    }, 600);
}

function stopFlash(){
    clearInterval(flashInterval);
    document.title = originalTitle;
}

function showSilentNotification(title, body){
    if (Notification.permission === "granted") {
        new Notification(title, { body: body, silent: true });
    }
}

function clearAll(){
    clearInterval(checkTimer);
    clearInterval(notificationRepeatInterval);
    stopFlash();
    overlay.style.display = "none";
    document.getElementById("result").innerText = "";
}

const note1 = document.getElementById("note1");
const note2 = document.getElementById("note2");
note1.value = localStorage.getItem("note1") || "";
note2.value = localStorage.getItem("note2") || "";
note1.addEventListener("input", () => localStorage.setItem("note1", note1.value));
note2.addEventListener("input", () => localStorage.setItem("note2", note2.value));
</script>

</body>
</html>
